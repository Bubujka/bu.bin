#!/usr/bin/env ruby
# encoding: UTF-8
"SoRrY fOr My RuBy"

require 'rubygems'
require 'yaml'
require 'thor'
require 'json'
require 'httparty'
require 'pp'

def _read_my_file 
  JSON.parse( File.read(File.expand_path('~/.puffy-my-cache.json')))
end

def _write_my_file data
  File.open(File.expand_path('~/.puffy-my-cache.json'), 'w') { |file| file.write(data.to_json) }
end


$larr = ' ← '

def format_my_list data
  plain = []
  data.each do |account, t|
    t.each do |prj|
      prj['assigned_todos'].each do |todo|
        itm = (todo['content'] + $larr + prj['name'] + ' (' + prj['bucket']['name']+')') 
        plain.push({name: itm, date: DateTime.rfc3339(todo['created_at'])})
      end
    end
  end
  plain.sort! { |x,y| y[:date] <=> x[:date] }

  puts '_____Newest_____'
  plain.first(5).each do |itm|
    puts itm[:name]
  end
  puts '.                 '
  puts '.                 '
  data.each do |account, t|
    t.each do |prj|
      title = '     ' + prj['bucket']['name'] + ': ' + prj['name']
      puts title.gsub("\n", ' ')
      prj['assigned_todos'].each do |todo|
        itm = (todo['content'] + $larr + prj['name'] + ' (' + prj['bucket']['name']+')') 
        puts itm.gsub("\n", ' ')
      end
      puts '.                 '
      puts '.                 '
    end
  end
end
class Puffy < Thor
  @@username = ENV['BASECAMP_LOGIN']
  @@password = ENV['BASECAMP_PASSWORD']

  @@cfg = YAML.load_file(File.expand_path("~/.puffyrc"))
  desc "targets", "Show all targets"
  def targets
    puts @@cfg['targets'].keys
  end

  desc "mycached", "Выводит список моих тасков в бэйскампе из кэша"
  def mycached 
    format_my_list _read_my_file
  end

  desc "my", "Выводит список моих тасков в бэйскампе"
  def my
    data = {}

    @@cfg['accounts'].each do |account, me|
      res = HTTParty.get("https://basecamp.com/#{account}/api/v1/people/#{me}/assigned_todos.json",
                    :basic_auth => { :username => @@username, :password => @@password },
                    :headers => {
                      "User-Agent" => 'Bubujka.Todo.Creator (zendzirou@gmail.com)',
                      "Content-Type" => "application/json"} )
      

      if res.code == 200
        t = JSON.parse( res.body )
        data[account] = t
      end
    end
    format_my_list data
    _write_my_file data
  end

  desc "sync", "Синхронизировать незалитые таски в бэйскамп (если инет не работал)"
  def sync
    Dir[File.expand_path("~/.puffy")+"/*"].each do |pth|
      info = YAML.load_file(pth)
      tgt = @@cfg['targets'][info[:target]]
      data = {}
      data["content"] = info[:text]
      if tgt['assignee']
        data["assignee"] = { "type"=>"Person", "id"=>tgt['assignee'] }
      end
      data = data.to_json
      p = HTTParty.post("https://basecamp.com/#{tgt['account']}/api/v1/projects/#{tgt['project']}/todolists/#{tgt['todolist']}/todos.json",
                    :basic_auth => { :username => @@username, :password => @@password },
                    :body => data,
                    :headers => {
                      "User-Agent" => 'Bubujka.Todo.Creator (zendzirou@gmail.com)',
                      "Content-Type" => "application/json"} )
      if p.code == 201
        File.unlink pth
      end
    end
  end

  desc "create TARGET TEXT", "Create task in target"
  def create target, text
    unless(@@cfg['targets'].keys.include? target)
      puts "Fucked target!"
      exit 1
    end
    info = { target: target, text: text }

    backup_file_name = Time.now.to_f.to_s
    backup_file_name = File.expand_path("~/.puffy/#{backup_file_name}")
    File.open(backup_file_name, 'w') {|f| f.write(info.to_yaml) }

    tgt = @@cfg['targets'][info[:target]]
    data = {}
    data["content"] = info[:text]
    if tgt['assignee']
      data["assignee"] = { "type"=>"Person", "id"=>tgt['assignee'] }
    end
    data = data.to_json
    p = HTTParty.post("https://basecamp.com/#{tgt['account']}/api/v1/projects/#{tgt['project']}/todolists/#{tgt['todolist']}/todos.json",
                  :basic_auth => { :username => @@username, :password => @@password },
                  :body => data,
                  :headers => {
                    "User-Agent" => 'Bubujka.Todo.Creator (zendzirou@gmail.com)',
                    "Content-Type" => "application/json"} )
    if p.code == 201
      puts "All good"
      File.unlink backup_file_name
      exit 0;
    end
    exit 2
  end
end
Puffy.start
